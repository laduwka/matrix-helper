# Matrix Helper

[English](README.md) | **Русский**

CLI-утилита на Go для управления комнатами Matrix: выход из неактивных комнат, поиск упоминаний, отметка прочитанного.

## Возможности

- **Выход из комнат по ключевым словам** - покинуть комнаты, содержащие в названии слова-маркеры закрытия (`close`, `done`, `resolved`, `completed`), с опциональной проверкой неактивности
- **Выход из всех неактивных комнат** - покинуть все комнаты без активности за указанный период (независимо от названия)
- **Поиск упоминаний** - найти комнаты, в которых вас упоминали, через Matrix notifications API (`/notifications`) с пагинацией; прямые ссылки на Element и веб-интерфейс
- **Отметить все как прочитанное** - снять статус непрочитанных со всех комнат одной командой (обрабатываются только комнаты с непрочитанными уведомлениями)
- **Интерактивный режим** - ввод учётных данных через терминал с маскировкой пароля
- **Кэширование сессии** - токен доступа сохраняется после первого входа; при повторном запуске пароль не запрашивается
- **Надёжная работа с API** - встроенный retry с exponential backoff, circuit breaker, rate limiter и общая пауза при серверном rate limit (429)

## Требования

- Go 1.24 или выше
- Учётная запись Matrix

## Установка

### Из исходников

```bash
git clone https://github.com/laduwka/matrix-helper.git
cd matrix-helper
make build
./matrix-helper --version
```

### Скачать бинарник

Готовые бинарники для вашей платформы доступны на странице [GitHub Releases](https://github.com/laduwka/matrix-helper/releases).

## Конфигурация

### Переменные окружения

```bash
# Обязательные
export MATRIX_DOMAIN="matrix.bingo-boom.ru"
export MATRIX_USERNAME="your_username"
export MATRIX_PASSWORD="your_password"

# Опциональные
export LOG_LEVEL="info"    # debug, info, warn, error
export LOG_FORMAT="text"   # text, json
export LOG_FILE=""         # путь к файлу лога (по умолчанию stdout)
```

### Интерактивный режим

Запустите с флагом `-i`, чтобы ввести учётные данные вручную:

```bash
matrix-helper -i
```

Программа запросит домен сервера (по умолчанию `matrix.bingo-boom.ru`), имя пользователя и пароль (вводится скрыто).

При первом запуске токен доступа кэшируется локально. Последующие запуски используют кэшированный токен без повторного запроса пароля. Для отзыва сессии используйте `--logout`.

## Использование

### Интерактивное меню

Запустите без флагов для выбора действия из меню:

```bash
matrix-helper
```

### CLI-флаги

| Флаг | Описание |
|------|----------|
| `-h`, `--help` | Показать справку |
| `--version` | Показать версию |
| `-i` | Интерактивный режим (ввод credentials) |
| `--logout` | Отозвать кэшированную сессию и удалить сохранённый токен |
| `--leave` | Режим выхода из комнат (по ключевым словам) |
| `--leave-inactive` | Режим выхода из всех неактивных комнат |
| `--days=N` | Количество дней неактивности |
| `--no-confirm` | Пропустить подтверждение (для cron/скриптов) |
| `--mentions` | Режим поиска упоминаний |
| `--mention-days=N` | Количество дней для поиска упоминаний (по умолчанию 30) |
| `--mark-read` | Отметить все комнаты как прочитанные |

### Примеры

**Выход из комнат с ключевыми словами закрытия, неактивных 60 дней:**
```bash
matrix-helper --leave --days=60
```

**Выход из всех неактивных комнат за 30 дней:**
```bash
matrix-helper --leave-inactive --days=30
```

Перед выполнением программа покажет список комнат и запросит подтверждение. Для автоматического запуска (cron) добавьте `--no-confirm`:

```bash
matrix-helper --leave-inactive --days=90 --no-confirm
```

**Поиск упоминаний за последнюю неделю:**
```bash
matrix-helper --mentions --mention-days=7
```

**Отметить все комнаты как прочитанные:**
```bash
matrix-helper --mark-read
```

**Интерактивный режим с ручным вводом:**
```bash
matrix-helper -i
```

**Выход из кэшированной сессии:**
```bash
matrix-helper --logout
```

## Кэширование сессии

В интерактивном режиме (`-i`) токен доступа кэшируется после первого успешного входа:

- **Расположение**: `$XDG_RUNTIME_DIR/matrix-helper/token.json` (если не задан — `~/.cache/matrix-helper/token.json`)
- **Права доступа**: директория `0700`, файл `0600` (доступ только владельцу)
- **Валидация**: при каждом запуске кэшированный токен проверяется через Matrix `/account/whoami`; если невалиден — запрашиваются учётные данные
- **Пароль не сохраняется**: кэшируется только токен доступа, пароль никогда не записывается
- **Выход**: `matrix-helper --logout` отзывает токен на сервере и удаляет локальный кэш

На системах с `$XDG_RUNTIME_DIR` (большинство Linux-дистрибутивов) токен хранится в tmpfs и автоматически удаляется при выходе из системы или перезагрузке.

## FAQ

**Q: Что делает `--leave` vs `--leave-inactive`?**

`--leave` покидает только комнаты, в названии которых есть ключевые слова закрытия (`close`, `done`, `resolved`, `completed`), плюс опциональная проверка неактивности через `--days`.

`--leave-inactive` покидает **все** комнаты без активности за указанный период, независимо от названия.

**Q: Можно ли отменить выход из комнаты?**

Нет, выход из комнаты необратим. Поэтому программа показывает список комнат и запрашивает подтверждение перед выполнением.

**Q: Как работает rate limiting?**

Программа автоматически ограничивает частоту запросов к серверу Matrix (20 запросов/мин). При получении ошибки 429 (Too Many Requests) все параллельные запросы приостанавливаются на время, указанное сервером (`retry_after_ms`), после чего возобновляются. Ретраи при 429 не расходуют лимит обычных повторных попыток.

**Q: Как работает поиск упоминаний?**

Программа использует Matrix API `/notifications` с фильтром `only=highlight`, который возвращает события, вызвавшие highlighted-уведомления (упоминания). Сервер сам определяет, что является упоминанием, через push rules — это надёжнее, чем ручной поиск по тексту, и работает с любым форматом упоминаний. Результаты пагинируются автоматически, поэтому упоминания не теряются даже в активных комнатах.

**Q: Как запустить по расписанию?**

Используйте cron с флагом `--no-confirm`:
```bash
# Каждое воскресенье в 3:00 - покинуть неактивные комнаты
0 3 * * 0 MATRIX_DOMAIN=... MATRIX_USERNAME=... MATRIX_PASSWORD=... /path/to/matrix-helper --leave-inactive --days=90 --no-confirm
```

## Лицензия

MIT License

## Зависимости

- [gomatrix](https://github.com/matrix-org/gomatrix) - Matrix клиент для Go
- [cenkalti/backoff](https://github.com/cenkalti/backoff) - Retry с exponential backoff
- [sony/gobreaker](https://github.com/sony/gobreaker) - Circuit breaker
- [golang.org/x/time/rate](https://pkg.go.dev/golang.org/x/time/rate) - Rate limiter
- [golang.org/x/sync](https://pkg.go.dev/golang.org/x/sync) - Примитивы конкурентности (errgroup, semaphore)
- [logrus](https://github.com/sirupsen/logrus) - Логирование
- [fatih/color](https://github.com/fatih/color) - Цветной вывод в терминале
